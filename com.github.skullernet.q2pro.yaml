app-id: com.github.skullernet.q2pro
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: q2pro.sh
rename-icon: q2pro
rename-desktop-file: q2pro.desktop
finish-args:
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri
modules:
  - name: q2pro
    buildsystem: meson
    builddir: true
    build-options:
      config-opts:
        - --werror
        - --fatal-meson-warnings
        - -Danticheat-server=true
        - -Dclient-gtv=true
        - -Dhomedir=/var/data
        - -Doss=auto
        - -Dpacketdup-hack=true
        - -Dtests=true
        - -Dvariable-fps=true
    post-install:
      - install -Dm775 ../q2pro.sh -t ${FLATPAK_DEST}/bin/
      - install -Dm644 ../q2pro.svg -t ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps
      - install -Dm644 ../com.github.skullernet.q2pro.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - desktop-file-edit --set-key=Exec --set-value='q2pro.sh +connect %u' ${FLATPAK_BUILDER_BUILDDIR}/src/unix/res/q2pro.desktop
      - desktop-file-edit --add-mime-type=x-scheme-handler/quake2 ${FLATPAK_BUILDER_BUILDDIR}/src/unix/res/q2pro.desktop
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/src/unix/res/q2pro.desktop -t ${FLATPAK_DEST}/share/applications
    sources:
      - type: archive
        url: https://github.com/skullernet/q2pro/archive/refs/tags/r2004.tar.gz
        sha256: 3a276e4a0fe1ebc7501fa23fcc22b2ec67e1a0f0c38f512c5335fe0d515f719b
        x-checker-data:
          type: anitya
          project-id: 197628
          url-template: https://github.com/skullernet/q2pro/archive/refs/tags/$version.tar.gz
      - type: file
        path: com.github.skullernet.q2pro.metainfo.xml
      - type: file
        path: q2pro.svg
      - type: patch
        path: meson_version.patch
      - type: script
        dest-filename: q2pro.sh
        commands:
          - ls ${XDG_DATA_HOME}/baseq2/pak0.pak || zenity --error --text "Game data
            (/baseq2/ etc.)  must be added to:\n${XDG_DATA_HOME}/baseq2/" --ok-label
            "Close" --width=400
          - /app/bin/q2pro "$@"
